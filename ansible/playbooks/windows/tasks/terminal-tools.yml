---
# tasks/terminal-tools.yml
# Installs terminal tools via WinGet with dynamic GitHub API fallback download

- name: Install terminal tools via WinGet
  win_package:
    name: "{{ item.name }}"
    id: "{{ item.id }}"
    state: present
  loop: "{{ tools }}"
  when: item.id | length > 0
  register: winget_results
  ignore_errors: true

- name: Ensure download directory exists
  win_file:
    path: "{{ download_dir }}"
    state: directory

- name: Dynamically fetch and download fallback tools from GitHub
  block:
    - name: Get latest release info from GitHub API
      uri:
        url: "https://api.github.com/repos/{{ item.repo_owner }}/{{ item.repo_name }}/releases/latest"
        return_content: yes
      register: release_info

    - name: Parse download URL from GitHub release JSON
      set_fact:
        download_url: "{{ (release_info.json.assets | selectattr('name','match', item.fallback_regex) | list)[0].browser_download_url }}"

    - name: Download latest release asset
      win_get_url:
        url: "{{ download_url }}"
        dest: "{{ download_dir }}\\{{ item.fallback_action }}"
        force: yes

    - name: Extract ZIP files if applicable
      win_unzip:
        src: "{{ download_dir }}\\{{ item.fallback_action }}"
        dest: "{{ download_dir }}"
        creates: "{{ download_dir }}\\{{ item.name }}"
        remote_src: true
      when: item.fallback_action is regex(".*\\.zip$")

    - name: Ensure download directory is in PATH
      win_path:
        elements: "{{ download_dir }}"
        state: present
  loop: "{{ tools | selectattr('fallback_action','defined') | selectattr('fallback_action','!=','') | list }}"
  loop_control:
    label: "{{ item.name }}"
  when: >
    (winget_results.results |
      selectattr('item.name','equalto', item.name) |
      selectattr('failed','equalto', true) |
      list |
      length > 0)

- name: Log tools with no fallback defined
  debug:
    msg: "No fallback available for {{ item.name }}"
  loop: "{{ tools }}"
  when: item.fallback_action | length == 0

# =====================================================================
# Vars (should be moved to vars/terminal-tools.yml)
# =====================================================================

  vars:
  download_dir: "{{ ansible_env.USERPROFILE }}\\bin"
  tools:
    - { name: lazygit, id: JesseDuffield.lazygit, fallback_action: "lazygit_x86_64.zip", repo_owner: jesseduffield, repo_name: lazygit, fallback_regex: ".*Windows_x86_64.zip$" }
    - { name: ripgrep, id: BurntSushi.ripgrep.MSVC, fallback_action: "ripgrep-x86_64.zip", repo_owner: BurntSushi, repo_name: ripgrep-prebuilt, fallback_regex: ".*x86_64.*windows.*zip$" }
    - { name: Yazi, id: yazi.yazi, fallback_action: "yazi-x86_64.zip", repo_owner: sxyazi, repo_name: yazi, fallback_regex: ".*windows.*x86_64.*zip$" }
    - { name: fd, id: sharkdp.fd, fallback_action: "fd-x86_64.zip", repo_owner: sharkdp, repo_name: fd, fallback_regex: ".*x86_64.*windows.*zip$" }
    - { name: Silver Searcher, id: JFLarvoire.Ag, fallback_action: "ag-x64.zip", repo_owner: k-takata, repo_name: the_silver_searcher-win32, fallback_regex: ".*x64.*zip$" }
    - { name: Git, id: Git.Git, fallback_action: "" }
    - { name: GitHub CLI, id: GitHub.cli, fallback_action: "" }
    - { name: fzf, id: junegunn.fzf, fallback_action: "" }
    - { name: bat, id: sharkdp.bat, fallback_action: "" }
    - { name: delta, id: dandavison.delta, fallback_action: "" }
    - { name: eza, id: eza.eza, fallback_action: "" }
    - { name: gsudo, id: gerardog.gsudo, fallback_action: "" }
    - { name: Starship, id: starship.starship, fallback_action: "" }
    - { name: Neovim, id: Neovim.Neovim, fallback_action: "" }
    - { name: VSCode, id: Microsoft.VisualStudioCode, fallback_action: "" }
    - { name: tldr, id: dbrgn.tealdeer, fallback_action: "" }
    - { name: zoxide, id: ajeetdsouza.zoxide, fallback_action: "" }
    - { name: fastfetch, id: fastfetch.fastfetch, fallback_action: "" }
    - { name: MiKTeX, id: MiKTeX.MiKTeX, fallback_action: "" }
    - { name: TRE, id: onetrueerror.tre, fallback_action: "" }
    - { name: Vale, id: errata-ai.vale, fallback_action: "" }
    - { name: Glow, id: charmbracelet.glow, fallback_action: "" }
    - { name: Lua, id: DEVCOM.Lua, fallback_action: "" }
    - { name: Globalping, id: globalping.globalping, fallback_action: "" }
